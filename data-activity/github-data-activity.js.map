{"version":3,"sources":["data-activity/github-data-activity.es6"],"names":[],"mappings":"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","file":"data-activity/github-data-activity.es6","sourcesContent":["/**\n * Copyright 2015 aixigo AG\n * Released under the MIT license.\n * http://laxarjs.org\n */\n\nimport patterns from 'laxar-patterns';\nimport handleAuth from '../lib/handle-auth';\nimport waitForEvent from '../lib/wait-for-event';\nimport extractPointers from '../lib/extract-pointers';\nimport throttledPublisherForFeature from '../lib/throttled-publisher';\nimport fetchAll from '../lib/fetch-all';\n\nconst OUTCOME_ERROR = patterns.actions.OUTCOME_ERROR;\nconst OUTCOME_SUCCESS = patterns.actions.OUTCOME_SUCCESS;\n\nexport const name = 'github-data-activity';\nexport const injections = [ 'axEventBus', 'axFeatures' ];\nexport const create = ( eventBus, features ) => new Controller( eventBus, features );\n\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\nclass Controller {\n   constructor( eventBus, features ) {\n      this.eventBus = eventBus;\n      this.features = features;\n\n      var baseOptions = {\n         method: 'GET',\n         headers: {}\n      };\n\n      const ready = handleAuth( eventBus, features, 'auth' )\n                       .then( setAuthHeader )\n                       .then( waitForEvent( eventBus, 'beginLifecycleRequest' ) );\n\n      var dataPublisher = throttledPublisherForFeature( this, 'data' );\n\n      if( features.data.sources.resource ) {\n         patterns.resources.handlerFor( this )\n            .registerResourceFromFeature( 'data.sources', {\n               onReplace: function( event ) {\n                  Promise.all( provideResources( event.data ) ).then( dataPublisher.replace );\n               },\n               onUpdate: function( event ) {\n                  var patches = event.patches.map( mapPatchValue.bind( null, provideResource ) );\n                  Promise.all( patches.map( wrapPatchInPromise ) ).then( dataPublisher.update );\n               }\n            } );\n      } else if( features.data.sources.length ) {\n         Promise.all( provideResources( features.data.sources ) ).then( dataPublisher.replace );\n      }\n\n      var provideActions = features.data.onActions || [];\n      var provideHandler = createRequestHandler( eventBus, provideResource );\n\n      provideActions.forEach( function( action ) {\n         eventBus.subscribe( 'takeActionRequest.' + action, provideHandler );\n      } );\n\n      eventBus.subscribe( 'beginLifecycleRequest', function() {\n      } );\n\n      eventBus.subscribe( 'endLifecycleRequest', function() {\n      } );\n\n      function setAuthHeader( data ) {\n         if( data && data.access_token ) {\n            baseOptions.headers[ 'Authorization' ] = 'token ' + data.access_token;\n         } else {\n            delete baseOptions.headers[ 'Authorization' ];\n         }\n      }\n\n      function provideResources( sources ) {\n         return sources.map( provideResource );\n      }\n\n      function provideResource( source ) {\n         const options = Object.create( baseOptions );\n         const follow = source.follow || features.data.sources.follow;\n\n         return ready.then( () =>\n            extractPointers( source, follow, ( url ) => fetchAll( url, options ) ) );\n      }\n   }\n\n}\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\nfunction mapPatchValue( callback, patch ) {\n   var result = {\n      op: patch.op,\n      path: patch.path\n   };\n   if( patch.from ) {\n      result.from = patch.from;\n   }\n   if( patch.value ) {\n      result.value = callback( patch.value );\n   }\n   return result;\n}\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\nfunction wrapPatchInPromise( patch ) {\n   if( patch.value ) {\n      return patch.value.then( ( value ) =>\n         mapPatchValue( () => value, patch ) );\n   } else {\n      return Promise.resolve( patch );\n   }\n}\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\nfunction createRequestHandler( eventBus, provider ) {\n\n   return function( event ) {\n      const action = event.action;\n      const data = event.data;\n      const resource = data.resource;\n      const topic = action + '-' + resource;\n\n      return eventBus.publish( 'willTakeAction.' + topic, {\n         action: action,\n         data: data\n      } ).then( function() {\n         return provider( data );\n      } ).then( function( data ) {\n         return eventBus.publish( 'didReplace.' + resource, {\n            resource: resource,\n            data: data\n         } );\n      } ).then( function() {\n         return OUTCOME_SUCCESS;\n      }, function( error ) {\n         console.log( error );\n         return OUTCOME_ERROR;\n      } ).then( function( outcome ) {\n         return eventBus.publish( 'didTakeAction.' + topic + '.' + outcome, {\n            action: action,\n            outcome: outcome,\n            data: data\n         } );\n      } );\n   };\n}\n\n"]}